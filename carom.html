<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Carom Score Tracker</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #121212;
  --surface: #1e1e1e;
  --surface2: #2a2a2a;
  --primary: #bb86fc;
  --primary-dim: #8858c8;
  --on-bg: #e0e0e0;
  --on-surface: #cccccc;
  --muted: #888888;
  --border: #333333;
  --danger: #cf6679;
  --success: #03dac6;
}

html, body {
  height: 100%;
  font-family: 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--on-bg);
  font-size: 14px;
  -webkit-tap-highlight-color: transparent;
  overflow: hidden;
}

/* ---- Tab bar ---- */
.tab-bar {
  display: flex;
  background: var(--surface);
  border-bottom: 2px solid var(--primary);
}
.tab-bar button {
  flex: 1;
  padding: 12px 0;
  background: none;
  border: none;
  color: var(--muted);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: color .15s, border-color .15s;
  border-bottom: 3px solid transparent;
}
.tab-bar button.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

/* ---- Tab content ---- */
.tab-content { display: none; height: calc(100vh - 47px); overflow-y: auto; }
.tab-content.active { display: flex; flex-direction: column; }

/* ---- Game tab ---- */
.game-top {
  display: flex;
  gap: 8px;
  padding: 8px;
  flex-shrink: 0;
}

/* Left column: fields */
.fields-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  flex: 1;
  align-content: start;
}

.field-group { display: flex; flex-direction: column; }
.field-group label {
  font-size: 10px;
  color: var(--muted);
  margin-bottom: 2px;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.field-group input, .field-group .ro-value {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--on-bg);
  padding: 6px 8px;
  font-size: 14px;
  width: 100%;
  text-align: center;
}
.field-group input:focus { border-color: var(--primary); outline: none; }
.field-group .ro-value {
  background: var(--surface2);
  color: var(--muted);
  border-color: transparent;
}

/* Right column: numpad + add */
.numpad-col {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 150px;
  flex-shrink: 0;
}
.numpad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 4px;
}
.numpad button {
  min-height: 44px;
  min-width: 44px;
  font-size: 18px;
  font-weight: 600;
  background: var(--surface2);
  color: var(--on-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: background .1s;
}
.numpad button:active { background: var(--primary-dim); }

.add-row {
  display: flex;
  gap: 4px;
  align-items: center;
}
.add-row .add-display {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--on-bg);
  padding: 8px;
  font-size: 16px;
  text-align: center;
  font-weight: 600;
}
.add-row button {
  min-height: 44px;
  min-width: 44px;
  font-size: 22px;
  font-weight: 700;
  background: var(--primary);
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.add-row button:active { background: var(--primary-dim); }

/* Action buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  padding: 0 8px 6px;
  flex-shrink: 0;
}
.action-buttons button {
  flex: 1;
  padding: 10px;
  font-size: 14px;
  font-weight: 600;
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  background: var(--surface);
  color: var(--on-bg);
  min-height: 44px;
}
.action-buttons .btn-reset { color: var(--danger); border-color: var(--danger); }
.action-buttons .btn-end { color: var(--success); border-color: var(--success); }
.action-buttons button:active { opacity: .7; }

/* Result table */
.result-table-wrap {
  flex: 1;
  overflow-y: auto;
  padding: 0 8px 8px;
}
.result-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.result-table th, .result-table td {
  padding: 6px 4px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}
.result-table th {
  color: var(--muted);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  position: sticky;
  top: 0;
  background: var(--bg);
}
.result-table td:first-child {
  color: var(--primary);
  font-weight: 600;
}

/* ---- Overall tab ---- */
.overall-tab { padding: 10px; gap: 12px; }

.overall-input-row {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}
.overall-input-row input {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--on-bg);
  padding: 10px 12px;
  font-size: 15px;
}
.overall-input-row input:focus { border-color: var(--primary); outline: none; }
.overall-input-row button {
  min-width: 64px;
  min-height: 44px;
  background: var(--primary);
  color: #000;
  border: none;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.stats-row {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}
.stats-row .stat-box {
  flex: 1;
  background: var(--surface);
  border-radius: 8px;
  padding: 10px;
  text-align: center;
}
.stats-row .stat-box .stat-label {
  font-size: 10px;
  color: var(--muted);
  text-transform: uppercase;
  margin-bottom: 4px;
}
.stats-row .stat-box .stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
}

.projections {
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex-shrink: 0;
}
.projection-row {
  display: flex;
  justify-content: space-between;
  background: var(--surface);
  border-radius: 6px;
  padding: 8px 12px;
}
.projection-row .proj-label { color: var(--muted); font-size: 13px; }
.projection-row .proj-value { font-weight: 600; font-size: 14px; }

/* Collapsible moyennes list */
.collapsible-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--surface);
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  flex-shrink: 0;
  user-select: none;
}
.collapsible-header .arrow { transition: transform .2s; font-size: 12px; color: var(--muted); }
.collapsible-header.open .arrow { transform: rotate(180deg); }
.moyennes-list {
  display: none;
  flex-direction: column;
  gap: 2px;
  overflow-y: auto;
  max-height: 300px;
  background: var(--surface);
  border-radius: 0 0 8px 8px;
  padding: 0 12px 10px;
}
.moyennes-list.open { display: flex; }
.moyennes-list .m-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 4px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  cursor: pointer;
  border-radius: 4px;
  margin: 0 -4px;
  transition: background .1s;
}
.moyennes-list .m-item:last-child { border-bottom: none; }
.moyennes-list .m-item:hover,
.moyennes-list .m-item:active { background: rgba(187,134,252,0.08); }
.moyennes-list .m-item .m-idx { color: var(--muted); min-width: 28px; }
.moyennes-list .m-item .m-val { font-weight: 600; }
.moyennes-list .m-item .m-meta { color: var(--muted); font-size: 11px; flex: 1; text-align: right; padding: 0 6px; }
.moyennes-list .m-item .m-arrow { color: var(--muted); font-size: 12px; }

.io-buttons {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}
.io-buttons button {
  flex: 1;
  min-height: 44px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--on-bg);
}
.io-buttons button:active { opacity: .7; }

/* ---- Game detail bottom sheet ---- */
.detail-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  z-index: 100;
}
.detail-sheet {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  max-height: 85vh;
  background: var(--surface);
  border-radius: 16px 16px 0 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transform: translateY(100%);
  transition: transform .28s cubic-bezier(0.4,0,0.2,1);
}
.detail-overlay.open .detail-sheet { transform: translateY(0); }
.detail-drag {
  width: 36px;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin: 10px auto 0;
  flex-shrink: 0;
}
.detail-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: 12px 16px 14px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.detail-title { font-weight: 700; font-size: 18px; color: var(--primary); }
.detail-subtitle { font-size: 12px; color: var(--muted); margin-top: 4px; line-height: 1.5; }
.detail-close {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: var(--surface2);
  border: none;
  color: var(--on-bg);
  font-size: 20px;
  cursor: pointer;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
.detail-chart-wrap {
  padding: 10px 12px 8px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.detail-chart-wrap .chart-legend {
  display: flex;
  gap: 14px;
  justify-content: center;
  font-size: 10px;
  color: var(--muted);
  margin-top: 4px;
}
.detail-chart-wrap .chart-legend span { display: flex; align-items: center; gap: 4px; }
.detail-no-data {
  padding: 24px;
  text-align: center;
  color: var(--muted);
  font-size: 13px;
  font-style: italic;
}
.detail-table-wrap { flex: 1; overflow-y: auto; }
.detail-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.detail-table th {
  padding: 7px 8px;
  text-align: center;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--surface);
  font-weight: 600;
}
.detail-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid var(--border); }
.detail-table tr:last-child td { border-bottom: none; }
.td-idx { color: var(--muted); }
.td-zero { color: var(--danger); font-weight: 600; }
.td-moy { color: var(--primary); }
</style>
</head>
<body>

<!-- Tab bar -->
<div class="tab-bar">
  <button class="active" data-tab="game">Game</button>
  <button data-tab="overall">Overall</button>
</div>

<!-- Game tab -->
<div id="tab-game" class="tab-content active">
  <div class="game-top">
    <!-- Left: fields -->
    <div class="fields-col">
      <div class="field-group">
        <label>Score</label>
        <input type="number" id="f-score" inputmode="numeric" value="0">
      </div>
      <div class="field-group">
        <label>Turns</label>
        <input type="number" id="f-turns" inputmode="numeric" value="0">
      </div>
      <div class="field-group">
        <label>Target</label>
        <input type="number" id="f-target" inputmode="decimal" step="0.01" value="0.90">
      </div>
      <div class="field-group">
        <label>Step</label>
        <input type="number" id="f-step" inputmode="decimal" step="0.01" value="0.10">
      </div>
      <div class="field-group">
        <label>Moyenne</label>
        <div class="ro-value" id="f-moyenne">0.00</div>
      </div>
      <div class="field-group">
        <label>Zeros</label>
        <div class="ro-value" id="f-zeros">0</div>
      </div>
    </div>

    <!-- Right: numpad -->
    <div class="numpad-col">
      <div class="numpad" id="numpad"></div>
      <div class="add-row">
        <div class="add-display" id="add-display">0</div>
        <button id="btn-add-score">+</button>
      </div>
    </div>
  </div>

  <div class="action-buttons">
    <button class="btn-reset" id="btn-reset">Reset</button>
    <button class="btn-end" id="btn-end">End Game</button>
  </div>

  <div class="result-table-wrap">
    <table class="result-table">
      <thead>
        <tr id="result-header"></tr>
      </thead>
      <tbody id="result-body"></tbody>
    </table>
  </div>
</div>

<!-- Overall tab -->
<div id="tab-overall" class="tab-content overall-tab">
  <div class="overall-input-row">
    <input type="number" id="ov-input" inputmode="decimal" step="0.01" placeholder="Enter moyenne...">
    <button id="btn-add-moyenne">Add</button>
  </div>

  <div class="stats-row">
    <div class="stat-box">
      <div class="stat-label">Avg Moyenne</div>
      <div class="stat-value" id="ov-avg">0.00</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Score Target</div>
      <div class="stat-value" id="ov-target">0</div>
    </div>
  </div>

  <div class="projections" id="ov-projections"></div>

  <div class="collapsible-header" id="moy-header">
    <span>Previous Moyennes (20)</span>
    <span class="arrow">&#9660;</span>
  </div>
  <div class="moyennes-list" id="moy-list"></div>

  <div class="io-buttons">
    <button id="btn-export">Export</button>
    <button id="btn-import">Import</button>
  </div>
  <input type="file" id="file-import" accept=".json" style="display:none">
</div>

<!-- Game detail bottom sheet -->
<div class="detail-overlay" id="detail-overlay">
  <div class="detail-sheet">
    <div class="detail-drag"></div>
    <div class="detail-header">
      <div>
        <div class="detail-title" id="detail-title"></div>
        <div class="detail-subtitle" id="detail-subtitle"></div>
      </div>
      <button class="detail-close" id="detail-close">&#xd7;</button>
    </div>
    <div class="detail-chart-wrap" id="detail-chart-wrap">
      <div id="detail-chart"></div>
      <div class="chart-legend">
        <span><svg width="20" height="4"><line x1="0" y1="2" x2="20" y2="2" stroke="#bb86fc" stroke-width="2"/></svg> Moyenne</span>
        <span><svg width="8" height="8"><circle cx="4" cy="4" r="3" fill="#cf6679"/></svg> Zero turn</span>
        <span><svg width="20" height="4"><line x1="0" y1="2" x2="20" y2="2" stroke="#bb86fc" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.5"/></svg> Final avg</span>
      </div>
    </div>
    <div class="detail-table-wrap">
      <table class="detail-table" id="detail-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Pts</th>
            <th>Total</th>
            <th>Moyenne</th>
          </tr>
        </thead>
        <tbody id="detail-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ============================================================
   CaromModel — direct port from Python CaromModel
   ============================================================ */
class CaromModel {
  static START_ENTERING_SCORE = 0;
  static UPDATE_ENTERING_SCORE = 1;
  static DEFAULT_TARGET = 0.90;
  static DEFAULT_TARGET_STEP = 0.10;
  static STORAGE_KEY = 'carom_moyennes';
  static DETAILS_KEY = 'carom_game_details';

  constructor() {
    this.currentScore = 0;
    this.playedTurns = 0;
    this.target = CaromModel.DEFAULT_TARGET;
    this.targetStep = CaromModel.DEFAULT_TARGET_STEP;
    this.numZeroScores = 0;
    this.inputState = CaromModel.START_ENTERING_SCORE;
    this.addScoreValue = 0;
    this.moyennesList = this.load();
    this.gameDetailsList = this.loadDetails();
    this.currentTurns = [];
  }

  /* --- Persistence --- */
  load() {
    try {
      const raw = localStorage.getItem(CaromModel.STORAGE_KEY);
      if (raw) {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr) && arr.length > 0) {
          while (arr.length < 20) arr.push(1.00);
          return arr.slice(0, 20).map(Number);
        }
      }
    } catch (_) { /* fall through */ }
    // Default placeholder moyennes (user can replace via Overall tab)
    return Array(20).fill(1.00);
  }

  loadDetails() {
    try {
      const raw = localStorage.getItem(CaromModel.DETAILS_KEY);
      if (raw) {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr) && arr.length > 0) {
          while (arr.length < 20) arr.unshift(null);
          return arr.slice(-20);
        }
      }
    } catch (_) { /* fall through */ }
    return Array(20).fill(null);
  }

  save() {
    localStorage.setItem(CaromModel.STORAGE_KEY, JSON.stringify(this.moyennesList));
  }

  saveDetails() {
    localStorage.setItem(CaromModel.DETAILS_KEY, JSON.stringify(this.gameDetailsList));
  }

  /* --- Calculations --- */
  getCurrentMoyenne() {
    return this.playedTurns > 0 ? this.currentScore / this.playedTurns : 0.0;
  }

  getAvgMoyenne() {
    if (!this.moyennesList.length) return 0.0;
    return this.moyennesList.reduce((a, b) => a + b, 0) / this.moyennesList.length;
  }

  getScoreTarget() {
    return Math.floor(25.0 * this.getAvgMoyenne());
  }

  /* --- Game actions --- */
  addToScore(points) {
    if (points === 0) this.numZeroScores++;
    this.currentScore += points;
    this.playedTurns++;
    // Record turn for detail tracking
    this.currentTurns.push({
      score: points,
      total: this.currentScore,
      moyenne: Math.round(this.getCurrentMoyenne() * 1000) / 1000
    });
  }

  resetGame() {
    this.currentScore = 0;
    this.playedTurns = 0;
    this.numZeroScores = 0;
    this.inputState = CaromModel.START_ENTERING_SCORE;
    this.addScoreValue = 0;
    this.currentTurns = [];
  }

  endGame() {
    if (this.playedTurns > 0) {
      const gm = Math.round(this.getCurrentMoyenne() * 100) / 100;
      this.moyennesList.shift();
      this.moyennesList.push(gm);
      this.save();

      // Save turn-by-turn details
      const details = {
        moyenne: gm,
        date: new Date().toISOString(),
        totalScore: this.currentScore,
        totalTurns: this.playedTurns,
        zeros: this.numZeroScores,
        turns: [...this.currentTurns]
      };
      this.gameDetailsList.shift();
      this.gameDetailsList.push(details);
      this.saveDetails();
    }
    this.resetGame();
  }

  addMoyenneToList(moyenne) {
    this.moyennesList.shift();
    this.moyennesList.push(moyenne);
    this.save();
    // No turn data for manually added moyennes
    this.gameDetailsList.shift();
    this.gameDetailsList.push(null);
    this.saveDetails();
  }

  /* --- Numpad input --- */
  updateInputDigit(digit) {
    if (this.inputState === CaromModel.START_ENTERING_SCORE) {
      this.addScoreValue = 0;
    }
    this.addScoreValue = this.addScoreValue * 10 + digit;
    this.inputState = CaromModel.UPDATE_ENTERING_SCORE;
  }

  undoInputDigit() {
    this.addScoreValue = Math.floor(this.addScoreValue / 10);
  }

  resetInput() {
    this.addScoreValue = 0;
    this.inputState = CaromModel.START_ENTERING_SCORE;
  }

  /* --- Score projections --- */
  scoreNeededByTurn(currentScore, playedTurns, targetScore, targetTurns) {
    let i = 0;
    while ((currentScore + i) * 100 < 100 * targetScore * (playedTurns + targetTurns)) {
      i++;
    }
    return i;
  }

  showNeededForPerc(score, playedTurns, target, numTurns = 10) {
    const result = [];
    for (let i = 0; i < numTurns; i++) {
      const needed = this.scoreNeededByTurn(score, playedTurns, target, i + 1);
      result.push({
        target,
        turns: i + 1,
        neededScore: needed,
        neededAvg: needed / (i + 1)
      });
    }
    return result;
  }

  showNeeded(currentScore, playedTurns, targetScore, targetStep, numTurns = 10) {
    const result = [];
    for (let i = 0; i < 3; i++) {
      result.push(this.showNeededForPerc(currentScore, playedTurns, targetScore + targetStep * i, numTurns));
    }
    return result;
  }

  calcExpectedGames(numGames, targMoyenne = null) {
    if (targMoyenne === null) targMoyenne = this.getAvgMoyenne();
    if (this.moyennesList.length < 20) return 0.0;
    const tail = this.moyennesList.slice(-(20 - numGames));
    const tailSum = tail.reduce((a, b) => a + b, 0);
    const result = (20.0 * targMoyenne - tailSum) / numGames;
    return Math.max(0.0, result);
  }
}


/* ============================================================
   UI Controller
   ============================================================ */
const NUM_RESULT_COLS = 5;
const model = new CaromModel();

/* --- DOM refs --- */
const $ = id => document.getElementById(id);

const fScore   = $('f-score');
const fTurns   = $('f-turns');
const fTarget  = $('f-target');
const fStep    = $('f-step');
const fMoyenne = $('f-moyenne');
const fZeros   = $('f-zeros');
const addDisp  = $('add-display');

/* --- Tab switching --- */
document.querySelectorAll('.tab-bar button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    $('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'overall') updateOverallTab();
  });
});

/* --- Build numpad --- */
(function buildNumpad() {
  const pad = $('numpad');
  const keys = [1,2,3,4,5,6,7,8,9,'x',0,'<'];
  keys.forEach(k => {
    const btn = document.createElement('button');
    btn.textContent = k;
    if (k === 'x') {
      btn.addEventListener('click', () => { model.resetInput(); model.numZeroScores = 0; syncView(); });
    } else if (k === '<') {
      btn.addEventListener('click', () => { model.undoInputDigit(); addDisp.textContent = model.addScoreValue; });
    } else {
      btn.addEventListener('click', () => { model.updateInputDigit(k); addDisp.textContent = model.addScoreValue; });
    }
    pad.appendChild(btn);
  });
})();

/* --- Build result table header --- */
(function buildResultHeader() {
  const tr = $('result-header');
  const th0 = document.createElement('th'); th0.textContent = 'Target \\ Turns'; tr.appendChild(th0);
  for (let i = 1; i <= NUM_RESULT_COLS; i++) {
    const th = document.createElement('th'); th.textContent = i; tr.appendChild(th);
  }
})();

/* --- Add score --- */
$('btn-add-score').addEventListener('click', () => {
  const val = model.addScoreValue;
  model.addToScore(val);
  model.resetInput();
  syncView();
});

/* --- Reset / End --- */
$('btn-reset').addEventListener('click', () => { model.resetGame(); syncView(); });
$('btn-end').addEventListener('click', () => { model.endGame(); syncView(); updateOverallTab(); });

/* --- Editable field handlers --- */
fScore.addEventListener('change', () => {
  model.currentScore = parseInt(fScore.value) || 0;
  syncView();
});
fTurns.addEventListener('change', () => {
  model.playedTurns = parseInt(fTurns.value) || 0;
  syncView();
});
fTarget.addEventListener('change', () => {
  model.target = parseFloat(fTarget.value) || CaromModel.DEFAULT_TARGET;
  syncView();
});
fStep.addEventListener('change', () => {
  model.targetStep = parseFloat(fStep.value) || CaromModel.DEFAULT_TARGET_STEP;
  syncView();
});

/* --- Sync all game view from model --- */
function syncView() {
  fScore.value = model.currentScore;
  fTurns.value = model.playedTurns;
  fTarget.value = model.target;
  fStep.value = model.targetStep;
  fMoyenne.textContent = model.getCurrentMoyenne().toFixed(2);
  fZeros.textContent = model.numZeroScores;
  addDisp.textContent = model.addScoreValue;
  updateResultTable();
}

/* --- Result table --- */
function updateResultTable() {
  const tbody = $('result-body');
  const results = model.showNeeded(model.currentScore, model.playedTurns, model.target, model.targetStep, NUM_RESULT_COLS);
  tbody.innerHTML = '';
  results.forEach(row => {
    const tr = document.createElement('tr');
    const tdTarget = document.createElement('td');
    tdTarget.textContent = row[0].target.toFixed(2);
    tr.appendChild(tdTarget);
    row.forEach(cell => {
      const td = document.createElement('td');
      td.textContent = cell.neededScore;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* ============================================================
   Overall tab
   ============================================================ */
$('btn-add-moyenne').addEventListener('click', () => {
  const val = parseFloat($('ov-input').value);
  if (isNaN(val)) return;
  model.addMoyenneToList(val);
  $('ov-input').value = '';
  updateOverallTab();
});

/* Collapsible */
$('moy-header').addEventListener('click', () => {
  $('moy-header').classList.toggle('open');
  $('moy-list').classList.toggle('open');
});

function formatGameDate(isoString) {
  const date = new Date(isoString);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today);
  yesterday.setDate(today.getDate() - 1);
  const gameDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  if (gameDay.getTime() === today.getTime()) return `Today ${time}`;
  if (gameDay.getTime() === yesterday.getTime()) return `Yesterday ${time}`;
  const opts = { month: 'short', day: 'numeric' };
  if (date.getFullYear() !== now.getFullYear()) opts.year = 'numeric';
  return `${date.toLocaleDateString([], opts)} ${time}`;
}

function updateOverallTab() {
  const avg = model.getAvgMoyenne();
  $('ov-avg').textContent = avg.toFixed(2);
  $('ov-target').textContent = model.getScoreTarget();

  /* Projections */
  const projWrap = $('ov-projections');
  projWrap.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const stepped = model.target + i * model.targetStep;
    const expected = model.calcExpectedGames(1, stepped);
    const div = document.createElement('div');
    div.className = 'projection-row';
    div.innerHTML = `<span class="proj-label">Target ${stepped.toFixed(2)}</span><span class="proj-value">${expected.toFixed(2)}</span>`;
    projWrap.appendChild(div);
  }

  /* Moyennes list — clickable items */
  const list = $('moy-list');
  list.innerHTML = '';
  model.moyennesList.forEach((m, i) => {
    const details = model.gameDetailsList[i];
    const div = document.createElement('div');
    div.className = 'm-item';
    div.setAttribute('role', 'button');
    div.setAttribute('tabindex', '0');

    let metaText = '';
    if (details) {
      metaText = formatGameDate(details.date);
    }

    div.innerHTML = `
      <span class="m-idx">${i + 1}.</span>
      <span class="m-val">${m.toFixed(2)}</span>
      <span class="m-meta">${metaText}</span>
      <span class="m-arrow">&#8250;</span>
    `;
    div.addEventListener('click', () => showGameDetail(i));
    div.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') showGameDetail(i); });
    list.appendChild(div);
  });
}

/* ============================================================
   Game detail bottom sheet
   ============================================================ */

function openDetailModal() {
  const overlay = $('detail-overlay');
  overlay.style.display = 'block';
  // Double rAF ensures the CSS transition fires after display:block
  requestAnimationFrame(() => requestAnimationFrame(() => overlay.classList.add('open')));
}

function closeDetailModal() {
  const overlay = $('detail-overlay');
  overlay.classList.remove('open');
  setTimeout(() => { overlay.style.display = 'none'; }, 300);
}

$('detail-close').addEventListener('click', closeDetailModal);
$('detail-overlay').addEventListener('click', e => {
  if (e.target === $('detail-overlay')) closeDetailModal();
});

function drawMoyenneChart(turns, container) {
  if (!turns || turns.length === 0) {
    container.innerHTML = '';
    return;
  }

  const W = 320, H = 130;
  const mg = { top: 14, right: 14, bottom: 22, left: 38 };
  const plotW = W - mg.left - mg.right;
  const plotH = H - mg.top - mg.bottom;

  const moyennes = turns.map(t => t.moyenne);
  const minMoy = Math.min(...moyennes);
  const maxMoy = Math.max(...moyennes);
  const spread = maxMoy - minMoy;
  // Ensure visible range even when all values identical
  const yPad = spread < 0.01 ? 0.3 : spread * 0.25;
  const yMin = Math.max(0, minMoy - yPad);
  const yMax = maxMoy + yPad;

  const xOf = i => mg.left + (turns.length > 1 ? (i / (turns.length - 1)) * plotW : plotW / 2);
  const yOf = v => mg.top + plotH - ((v - yMin) / (yMax - yMin)) * plotH;

  const finalMoy = moyennes[moyennes.length - 1];
  const finalY = yOf(finalMoy);

  // Y-axis grid: 4 levels
  const yTicks = [yMin, yMin + (yMax - yMin) / 3, yMin + 2 * (yMax - yMin) / 3, yMax];

  let svg = `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;display:block">`;

  // Grid lines + Y labels
  yTicks.forEach(v => {
    const y = yOf(v);
    svg += `<line x1="${mg.left}" y1="${y}" x2="${W - mg.right}" y2="${y}" stroke="#2e2e2e" stroke-width="1"/>`;
    svg += `<text x="${mg.left - 5}" y="${y + 4}" text-anchor="end" font-size="9" fill="#666">${v.toFixed(2)}</text>`;
  });

  // Final moyenne reference dashed line
  svg += `<line x1="${mg.left}" y1="${finalY}" x2="${W - mg.right}" y2="${finalY}" stroke="#bb86fc" stroke-width="1.5" stroke-dasharray="4,4" opacity="0.45"/>`;

  // Shaded area under the line
  const ptsList = turns.map((t, i) => `${xOf(i)},${yOf(t.moyenne)}`).join(' ');
  const areaPoints = `${mg.left},${mg.top + plotH} ${ptsList} ${xOf(turns.length - 1)},${mg.top + plotH}`;
  svg += `<polygon points="${areaPoints}" fill="#bb86fc" opacity="0.07"/>`;

  // Main polyline
  svg += `<polyline points="${ptsList}" fill="none" stroke="#bb86fc" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>`;

  // Dots (skip individual dots for long games to avoid clutter)
  const showDots = turns.length <= 25;
  turns.forEach((t, i) => {
    const cx = xOf(i);
    const cy = yOf(t.moyenne);
    const isZero = t.score === 0;
    if (showDots) {
      svg += `<circle cx="${cx}" cy="${cy}" r="${isZero ? 3.5 : 2.5}" fill="${isZero ? '#cf6679' : '#bb86fc'}" stroke="${isZero ? '#cf6679' : '#1e1e1e'}" stroke-width="1"/>`;
    } else if (isZero) {
      // Always show zero-score markers even on long games
      svg += `<circle cx="${cx}" cy="${cy}" r="3" fill="#cf6679"/>`;
    }
  });

  // X-axis labels: show first, last, and a few in between
  const xLabelCount = Math.min(5, turns.length);
  const step = turns.length > 1 ? Math.round((turns.length - 1) / (xLabelCount - 1)) : 0;
  const xLabels = new Set([0, turns.length - 1]);
  for (let k = 1; k < xLabelCount - 1; k++) xLabels.add(Math.round(k * step));
  xLabels.forEach(i => {
    svg += `<text x="${xOf(i)}" y="${H - mg.bottom + 13}" text-anchor="middle" font-size="9" fill="#666">${i + 1}</text>`;
  });

  // Axis lines
  svg += `<line x1="${mg.left}" y1="${mg.top}" x2="${mg.left}" y2="${mg.top + plotH}" stroke="#444" stroke-width="1"/>`;
  svg += `<line x1="${mg.left}" y1="${mg.top + plotH}" x2="${W - mg.right}" y2="${mg.top + plotH}" stroke="#444" stroke-width="1"/>`;

  svg += '</svg>';
  container.innerHTML = svg;
}

function showGameDetail(idx) {
  const moy = model.moyennesList[idx];
  const details = model.gameDetailsList[idx];

  // Title: game number + moyenne
  $('detail-title').textContent = `Game ${idx + 1} · ${moy.toFixed(2)} moy.`;

  if (details) {
    const dateStr = formatGameDate(details.date);
    const zerosTxt = details.zeros > 0 ? ` · ${details.zeros} zero${details.zeros > 1 ? 's' : ''}` : '';
    $('detail-subtitle').textContent = `${dateStr} · ${details.totalScore} pts · ${details.totalTurns} turns${zerosTxt}`;

    // Chart
    $('detail-chart-wrap').style.display = '';
    drawMoyenneChart(details.turns, $('detail-chart'));

    // Turn table
    const tbody = $('detail-tbody');
    tbody.innerHTML = details.turns.map((t, i) => {
      const isZero = t.score === 0;
      return `<tr>
        <td class="td-idx">${i + 1}</td>
        <td class="${isZero ? 'td-zero' : ''}">${t.score}</td>
        <td>${t.total}</td>
        <td class="td-moy">${t.moyenne.toFixed(2)}</td>
      </tr>`;
    }).join('');
  } else {
    $('detail-subtitle').textContent = 'Manually added · no turn data';
    $('detail-chart-wrap').style.display = 'none';
    $('detail-tbody').innerHTML = `<tr><td colspan="4" class="detail-no-data" style="padding:24px;text-align:center;color:var(--muted);font-style:italic">Turn-by-turn data is only available for games played with the numpad.</td></tr>`;
  }

  openDetailModal();
}

/* --- Export / Import --- */
$('btn-export').addEventListener('click', () => {
  const json = JSON.stringify(model.moyennesList, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'carom_moyennes.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

$('btn-import').addEventListener('click', () => $('file-import').click());
$('file-import').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const arr = JSON.parse(reader.result);
      if (!Array.isArray(arr) || arr.length === 0) throw new Error();
      const nums = arr.slice(0, 20).map(Number);
      while (nums.length < 20) nums.push(1.00);
      model.moyennesList = nums;
      model.save();
      // Imported moyennes have no turn detail data
      model.gameDetailsList = Array(20).fill(null);
      model.saveDetails();
      updateOverallTab();
    } catch (_) {
      alert('Invalid file. Expected a JSON array of numbers.');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

/* --- Initial render --- */
syncView();
updateOverallTab();
</script>
</body>
</html>
